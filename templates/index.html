<!DOCTYPE html>
<html>
<head>
  <title>Siri Link</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Bootstrap (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --card: rgba(255,255,255,.08);
      --border: rgba(255,255,255,.12);
      --muted: rgba(255,255,255,.65);
      --muted2: rgba(255,255,255,.45);
      --good:#35d07f;
      --bad:#ff5b5b;
      --accent1:#4f7cff;
      --accent2:#6b9cff;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius: 18px;
    }

    * { font-family: -apple-system,BlinkMacSystemFont,"SF Pro Display",system-ui,Segoe UI,Roboto,Arial,sans-serif; }

    body{
      min-height: 100vh;
      margin:0;
      color:white;
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(79,124,255,.18), transparent 55%),
        radial-gradient(900px 600px at 90% 30%, rgba(53,208,127,.12), transparent 55%),
        linear-gradient(135deg, #14162a, #0a0b12);
    }

    .glass{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(22px);
      -webkit-backdrop-filter: blur(22px);
    }

    .logo{
      width:40px; height:40px;
      border-radius:14px;
      background: linear-gradient(135deg, rgba(79,124,255,.95), rgba(107,156,255,.95));
      box-shadow: 0 12px 40px rgba(79,124,255,.35);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:18px;
      flex:0 0 auto;
    }

    .subtitle{ color: var(--muted); font-size: 12px; }

    .pill{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      padding:8px 12px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }

    .dot{ width:8px; height:8px; border-radius:999px; background:rgba(255,255,255,.35); }
    .dot.good{ background: var(--good); box-shadow: 0 0 0 5px rgba(53,208,127,.12); }

    /* Tighter spacing than before */
    .tight-pad { padding: 16px; }
    @media (min-width: 576px){ .tight-pad { padding: 18px; } }

    .btn-glass{
      border: 1px solid rgba(255,255,255,.12) !important;
      background: rgba(255,255,255,.10) !important;
      color: white !important;
      border-radius: 12px !important;
      transition: .2s ease;
      font-weight: 600;
    }
    .btn-glass:hover{ transform: translateY(-1px); background: rgba(255,255,255,.16) !important; }

    .btn-primary-glow{
      border: none !important;
      background: linear-gradient(135deg, var(--accent1), var(--accent2)) !important;
      color: white !important;
      border-radius: 12px !important;
      box-shadow: 0 16px 44px rgba(79,124,255,.22);
      font-weight: 700;
    }
    .btn-primary-glow:hover{ box-shadow: 0 16px 44px rgba(79,124,255,.35); transform: translateY(-1px); }

    .btn-danger-soft{
      border: 1px solid rgba(255,91,91,.22) !important;
      background: rgba(255,91,91,.12) !important;
      color: white !important;
      border-radius: 12px !important;
      font-weight: 700;
    }
    .btn-danger-soft:hover{ background: rgba(255,91,91,.18) !important; transform: translateY(-1px); }

    .badge-soft{
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      white-space:nowrap;
    }
    .badge-good{ border-color: rgba(53,208,127,.25); background: rgba(53,208,127,.12); color: rgba(255,255,255,.95); }
    .badge-bad{ border-color: rgba(255,91,91,.25); background: rgba(255,91,91,.12); color: rgba(255,255,255,.95); }

    .codebox{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      color: rgba(255,255,255,.88);
      background: rgba(0,0,0,.28);
      border: 1px solid rgba(255,255,255,.08);
      padding: 10px;
      border-radius: 12px;
      overflow:auto;
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 110px;
    }

    .muted{ color: var(--muted); }
    .muted2{ color: var(--muted2); }

    /* Keep the two-column feel longer; stack only when needed */
    @media (max-width: 991.98px){
      /* Still stacked on true tablet widths (Bootstrap lg breakpoint),
         but padding stays tight and things don't look huge. */
    }

    /* Logs */
    .log-scroll{
      max-height: 420px;
      overflow:auto;
      padding-right: 6px;
    }
    .log-item{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      border-radius: 14px;
      padding: 12px;
    }

    /* Modal glass */
    .modal-content.glass{
      background: rgba(20,22,42,.55);
      border: 1px solid rgba(255,255,255,.14);
    }
  </style>
</head>

<body>
  <div class="container py-3 py-sm-4">

    <!-- Header -->
    <div class="glass tight-pad mb-3">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
        <div class="d-flex align-items-center gap-3">
          <div class="logo">ðŸ”—</div>
          <div class="min-w-0">
            <div class="fw-bold" style="letter-spacing:.3px;">Siri Link</div>
            <div class="subtitle">Local network control panel â€¢ Commands â€¢ Activity â€¢ Admin</div>
          </div>
        </div>

        {% if not login_only %}
        <div class="d-flex align-items-center gap-2 flex-wrap">
          <div class="pill">
            <span class="dot good"></span>
            Authenticated
          </div>
          <button class="btn btn-glass btn-sm" onclick="location.reload()">Refresh</button>
        </div>
        {% endif %}
      </div>
    </div>

    {% if login_only %}

      <!-- Login -->
      <div class="glass tight-pad mx-auto" style="max-width:520px;">
        <div class="fw-bold mb-1">Authentication Required</div>
        <div class="muted mb-3" style="font-size:12px;">Enter your dashboard password to access Siri Link.</div>

        {% if login_error %}
          <div class="mb-3" style="color: rgba(255,91,91,.95); font-size: 13px;">{{ login_error }}</div>
        {% endif %}

        <form method="POST" action="/login">
          <div class="mb-3">
            <label class="form-label muted mb-1" style="font-size:12px;">Dashboard Password</label>
            <input class="form-control text-white"
                   style="background:rgba(255,255,255,.07); border:1px solid rgba(255,255,255,.10); border-radius:12px;"
                   type="password" name="password" placeholder="Enter password" required>
          </div>
          <button class="btn btn-primary-glow w-100" type="submit">Login</button>
        </form>
      </div>

    {% else %}

      <!-- Main layout (tight, not mega spaced) -->
      <div class="row g-3 align-items-start">

        <!-- LEFT: Commands -->
        <div class="col-12 col-lg-7">
          <div class="glass tight-pad">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
              <div class="fw-bold">Custom Commands</div>
              <span class="badge-soft">{{ commands|length }} total</span>
            </div>
            <div class="muted2 mb-3" style="font-size:12px;">
              Run, toggle, and inspect what each command does.
            </div>

            <div class="row g-3">
              {% for name, data in commands.items() %}
              <div class="col-12 col-md-6">
                <div class="glass tight-pad h-100">
                  <div class="d-flex align-items-start justify-content-between gap-2 mb-2">
                    <div class="min-w-0">
                      <div class="fw-bold text-truncate">{{ name }}</div>
                      <div class="muted2" style="font-size:12px;">
                        {{ data.get("description", "No description set") }}
                      </div>
                    </div>

                    {% if data.enabled %}
                      <span class="badge-soft badge-good">Enabled</span>
                    {% else %}
                      <span class="badge-soft badge-bad">Disabled</span>
                    {% endif %}
                  </div>

                  <div class="codebox mb-3">{{ data.command }}</div>

                  <div class="d-flex flex-wrap gap-2">
                    <button class="btn btn-primary-glow btn-sm {{ 'disabled' if not data.enabled else '' }}"
                            onclick="run('{{ name }}')">Run</button>

                    <button class="btn btn-glass btn-sm" onclick="toggle('{{ name }}')">Toggle</button>

                    <!-- FIXED: no inline JSON. Use data-* attributes -->
                    <button class="btn btn-glass btn-sm edit-btn"
                            data-name="{{ name|e }}"
                            data-command="{{ data.command|e }}"
                            data-description="{{ data.get('description','')|e }}"
                            data-enabled="{{ 'true' if data.enabled else 'false' }}"
                            onclick="handleEditClick(this)">
                      Edit
                    </button>

                    <button class="btn btn-danger-soft btn-sm" onclick="openDeleteModal('{{ name|e }}')">Delete</button>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>

        <!-- RIGHT: Editor + Passwords + Logs -->
        <div class="col-12 col-lg-5">
          <div class="d-flex flex-column gap-3">

            <!-- Editor -->
            <div class="glass tight-pad">
              <div class="fw-bold mb-1">Command Editor</div>
              <div class="muted2 mb-3" style="font-size:12px;">
                Create or update a command. Use <b>Edit</b> on a card to pre-fill this form.
              </div>

              <div class="row g-2">
                <div class="col-12 col-sm-6">
                  <label class="form-label muted mb-1" style="font-size:12px;">Name</label>
                  <input id="cmd_name" class="form-control text-white"
                         style="background:rgba(255,255,255,.07); border:1px solid rgba(255,255,255,.10); border-radius:12px;"
                         placeholder="e.g. lock">
                </div>

                <div class="col-12 col-sm-6">
                  <label class="form-label muted mb-1" style="font-size:12px;">Enabled</label>
                  <input id="cmd_enabled" class="form-control text-white"
                         style="background:rgba(255,255,255,.07); border:1px solid rgba(255,255,255,.10); border-radius:12px;"
                         placeholder="true / false">
                </div>

                <div class="col-12">
                  <label class="form-label muted mb-1" style="font-size:12px;">Description</label>
                  <input id="cmd_desc" class="form-control text-white"
                         style="background:rgba(255,255,255,.07); border:1px solid rgba(255,255,255,.10); border-radius:12px;"
                         placeholder="What it does">
                </div>

                <div class="col-12">
                  <label class="form-label muted mb-1" style="font-size:12px;">Command (system)</label>
                  <textarea id="cmd_exec" class="form-control text-white"
                            style="background:rgba(255,255,255,.07); border:1px solid rgba(255,255,255,.10); border-radius:12px;"
                            rows="4" placeholder="e.g. rundll32.exe user32.dll,LockWorkStation"></textarea>
                </div>

                <div class="col-12 d-flex flex-wrap gap-2">
                  <button class="btn btn-primary-glow" onclick="saveCommand()">Save</button>
                  <button class="btn btn-glass" onclick="clearEditor()">Clear</button>
                </div>
              </div>
            </div>

            <!-- Passwords -->
            <div class="glass tight-pad">
              <div class="fw-bold mb-1">Password & API Settings</div>
              <div class="muted2 mb-3" style="font-size:12px;">
                Dashboard login and API execution passwords are separate.
              </div>

              <div class="mb-2">
                <label class="form-label muted mb-1" style="font-size:12px;">New Dashboard Password</label>
                <input id="login_pw" class="form-control text-white"
                       style="background:rgba(255,255,255,.07); border:1px solid rgba(255,255,255,.10); border-radius:12px;"
                       placeholder="Leave blank to keep unchanged">
              </div>

              <div class="mb-2">
                <label class="form-label muted mb-1" style="font-size:12px;">New API Password</label>
                <input id="api_pw" class="form-control text-white"
                       style="background:rgba(255,255,255,.07); border:1px solid rgba(255,255,255,.10); border-radius:12px;"
                       placeholder="Leave blank to keep unchanged">
              </div>

              <div class="d-flex flex-wrap gap-2 mt-2">
                <button class="btn btn-glass" onclick="updatePasswords()">Update</button>
                <button class="btn btn-primary-glow" onclick="generateApiPassword()">Generate API Password</button>
                <button class="btn btn-glass btn-sm" onclick="copyGenerated()">Copy</button>
              </div>

              <div id="generated_box" class="codebox mt-3 d-none"></div>
            </div>

            <!-- Logs -->
            <div class="glass tight-pad">
              <div class="fw-bold mb-1">Recent Activity</div>
              <div class="muted2 mb-3" style="font-size:12px;">Latest command executions and access attempts.</div>

              <div class="log-scroll d-flex flex-column gap-2">
                {% for log in logs %}
                <div class="log-item">
                  <div class="d-flex align-items-start justify-content-between gap-2">
                    <div class="min-w-0">
                      <div class="text-truncate" style="font-size:12px; color: rgba(255,255,255,.88);">
                        {{ log.time }} â€¢ {{ log.ip }} â€¢ {{ log.command }}
                      </div>
                      <div class="muted2 text-truncate" style="font-size:11px;">
                        {% if log.get("password_attempt") %} Password attempt logged {% else %} No password attempt {% endif %}
                      </div>
                    </div>

                    {% if log.success %}
                      <span class="badge-soft badge-good">SUCCESS</span>
                    {% else %}
                      <span class="badge-soft badge-bad">FAIL</span>
                    {% endif %}
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Delete Confirm Modal -->
      <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content glass">
            <div class="modal-header border-0">
              <h5 class="modal-title fw-bold">Delete Command</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
              <div class="muted mb-2" style="font-size:13px;">
                Youâ€™re about to delete:
              </div>
              <div id="deleteCmdName" class="codebox" style="max-height:none;"></div>
              <div class="muted2 mt-2" style="font-size:12px;">
                This removes it from your command registry immediately.
              </div>
            </div>

            <div class="modal-footer border-0 d-flex gap-2">
              <button type="button" class="btn btn-glass" data-bs-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-danger-soft" onclick="confirmDeleteNow()">Yes, Delete</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Bootstrap JS -->
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

      <script>
        let deleteTargetName = null;

        function run(cmd){
          fetch("/execute",{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({command:cmd})
          }).then(()=>location.reload())
        }

        function toggle(cmd){
          fetch("/toggle",{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({command:cmd})
          }).then(()=>location.reload())
        }

        // FIXED edit: read from data attributes (safe for quotes/backslashes)
        function handleEditClick(btn){
          const name = btn.dataset.name || "";
          const command = btn.dataset.command || "";
          const description = btn.dataset.description || "";
          const enabled = btn.dataset.enabled || "true";

          document.getElementById("cmd_name").value = name;
          document.getElementById("cmd_exec").value = command;
          document.getElementById("cmd_desc").value = description;
          document.getElementById("cmd_enabled").value = enabled;

          // Smooth scroll editor into view on mobile
          document.getElementById("cmd_name").scrollIntoView({ behavior: "smooth", block: "center" });
        }

        function clearEditor(){
          document.getElementById("cmd_name").value = "";
          document.getElementById("cmd_exec").value = "";
          document.getElementById("cmd_desc").value = "";
          document.getElementById("cmd_enabled").value = "";
        }

        function saveCommand(){
          const enabledRaw = (document.getElementById("cmd_enabled").value || "true").trim().toLowerCase();
          const enabled = !(enabledRaw === "false" || enabledRaw === "0" || enabledRaw === "no");

          fetch("/save_command",{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({
              name: document.getElementById("cmd_name").value.trim(),
              command: document.getElementById("cmd_exec").value,
              enabled: enabled,
              description: document.getElementById("cmd_desc").value
            })
          }).then(()=>location.reload())
        }

        // Modal delete flow
        function openDeleteModal(name){
          deleteTargetName = name;
          document.getElementById("deleteCmdName").textContent = name;

          const modalEl = document.getElementById("deleteModal");
          const modal = new bootstrap.Modal(modalEl);
          modal.show();
        }

        function confirmDeleteNow(){
          if(!deleteTargetName) return;

          fetch("/delete_command",{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({ name: deleteTargetName })
          }).then(()=>location.reload())
        }

        function updatePasswords(){
          fetch("/update_passwords",{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({
              login_password: document.getElementById("login_pw").value,
              api_password: document.getElementById("api_pw").value
            })
          }).then(()=>alert("Updated"))
        }

        function generateApiPassword(){
          fetch("/generate_api_password",{ method:"POST" })
            .then(r=>r.json())
            .then(data=>{
              const box = document.getElementById("generated_box");
              box.classList.remove("d-none");
              box.textContent = data.password;
            });
        }

        function copyGenerated(){
          const box = document.getElementById("generated_box");
          if (!box || box.classList.contains("d-none")) return;
          navigator.clipboard.writeText(box.textContent).then(()=>alert("Copied"));
        }
      </script>

    {% endif %}
  </div>
</body>
</html>
